<!DOCTYPE html>
<html lang="es" data-theme="light">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="ALLTECH - Sistema de Gestión de Soporte Técnico">
  <meta name="author" content="ALLTECH">

  <title>ALLTECH - Soporte Técnico</title>

  <!-- Debug móvil -->
  <script src="https://cdn.jsdelivr.net/npm/eruda"></script>
  <script>eruda.init();</script>

  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml"
    href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%231a73e8' rx='15' width='100' height='100'/><text x='50%' y='55%' dominant-baseline='middle' text-anchor='middle' fill='white' font-family='Arial' font-size='45' font-weight='bold'>AT</text></svg>">

  <!-- Google Fonts - Inter -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Stylesheets -->
  <link rel="stylesheet" href="css/tokens.css">
  <link rel="stylesheet" href="css/base.css">
  <link rel="stylesheet" href="css/layout.css">
  <link rel="stylesheet" href="css/components.css">
  <link rel="stylesheet" href="css/modal.css">
  <link rel="stylesheet" href="css/forms.css">
  <link rel="stylesheet" href="css/modules.css">
  <link rel="stylesheet" href="css/modules-tabs.css">
  <link rel="stylesheet" href="css/permissions.css">\r\n
  <link rel="stylesheet" href="css/report-editor.css">
  <link rel="stylesheet" href="css/responsive-optimization.css">
  <link rel="stylesheet" href="css/welcome-animations.css">

  <!-- Supabase Client Library -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    /* Loading screen */
    .loading-screen {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-primary);
      z-index: 9999;
      transition: opacity 0.3s ease;
    }

    .loading-screen.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 4px solid var(--border-color);
      border-top-color: var(--color-primary-500);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* Hide app until loaded */
    #app:empty::before {
      content: '';
      display: block;
      width: 100%;
      height: 100vh;
    }

    /* Mobile menu button visibility */
    .header__menu-btn {
      display: none;
    }

    @media (max-width: 1024px) {
      .header__menu-btn {
        display: flex;
      }
    }
  </style>
</head>

<body>
  <!-- Loading Screen -->
  <div class="loading-screen" id="loadingScreen">
    <div class="loading-spinner"></div>
  </div>

  <!-- App Container -->
  <div id="app" class="app"></div>


  <!-- Device Detection (must load first) -->
  <script src="js/device-detection.js"></script>

  <!-- Services -->
  <script src="js/services/state.js"></script>

  <!-- Supabase Configuration & Service -->
  <script src="js/config/supabase.js"></script>
  <script src="js/services/supabase-data-service.js"></script>

  <!-- Legacy Services (fallback) -->
  <script src="js/services/data-service.js"></script>
  <script src="js/services/log-service.js"></script>
  <script src="js/services/whatsapp-service.js"></script>
  <script src="js/services/email-service.js"></script>
  <script src="js/icons.js"></script>

  <!-- Modules -->
  <script src="js/modules/login-module.js"></script>
  <script src="js/modules/clientes.js"></script>
  <script src="js/modules/contratos.js"></script>
  <script src="js/modules/contract-editor-module.js"></script>
  <script src="js/modules/visitas.js"></script>
  <script src="js/modules/equipos.js"></script>
  <script src="js/modules/software.js"></script>
  <script src="js/modules/calendario.js"></script>
  <script src="js/modules/reportes.js"></script>
  <script src="js/modules/config-module.js"></script>
  <script src="js/modules/productos.js"></script>
  <script src="js/modules/proformas.js"></script>
  <script src="js/modules/report-editor.js"></script>
  <script src="js/welcome-module.js"></script>


  <!-- Session Sync -->
  <script src="js/services/session-sync.js"></script>
  <!-- Main App -->
  <script src="js/app.js"></script>

  <script>
    // Initialize with session sync
    document.addEventListener('DOMContentLoaded', async () => {
      // IMPORTANT: State.init() MUST run first to load localStorage data
      State.init();

      // Now sync can correctly verify state vs Supabase session
      await SessionSync.checkAndSync();

      // Initialize the app (State.init is idempotent, so it's safe to call again)
      App.init();
    });

    // Hide loading screen
    window.addEventListener('load', () => {
      setTimeout(() => {
        document.getElementById('loadingScreen').classList.add('hidden');
      }, 300);
    });
  </script>
</body>

</html>